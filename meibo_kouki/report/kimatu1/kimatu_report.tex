\documentclass[a4j,11pt]{jarticle}
% ファイル先頭から\begin{document}までの内容（プレアンブル）については，
% 教員からの指示がない限り， { } の中を書き換えるだけでよい．


% ToDo: 提出要領に従って，適切な余白を設定する
\usepackage[top=25truemm,  bottom=30truemm,
            left=25truemm, right=25truemm]{geometry}


% ToDo: 提出要領に従って，適切なタイトル・サブタイトルを設定する
\title{プログラミング演習2 \\
       期末レポート}

% ToDo: 自分自身の氏名と学生番号に書き換える
\author{氏名: 今田将也 (IMADA, Masaya) \\
        学生番号: 09430509}

% ToDo: 教員の指示に従って適切に書き換える
\date{出題日: 2019年04月10日 \\
      提出日: 2019年xx月xx日 \\
      締切日: 2019年07月29日 \\}  % 注：最後の\\は不要に見えるが必要．

% ToDo: 図を入れる場合，以下の1行を有効にする
\usepackage{graphicx}

\begin{document}
\maketitle

% 目次つきの表紙ページにする場合はコメントを外す
%{\footnotesize \tableofcontents \newpage}

% 以下の7行は提出用のレポートでは必ず消すこと
%\textbf{\small※執筆上の注意：本書は空想上の課題に対するレポートの
%   執筆例である．章の構成と書くべき内容の参考として提示するもの
%    であるため，課題内容やプログラムの仕様などは，
%    実際の演習課題の指示に従って適切にまとめ直す必要がある．
%    途中まで文を書いて「・・・」によって省略している箇所があるが，
%    これに穴埋めをすることで提出できるレポートになるわけではない．
%    また，サンプルと同じ書き出しで文章を書く必要はない．}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{概要}\label{sec:gaiyou}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 以下の4行は提出用のレポートでは必ず消すこと
%\textbf{\small※執筆上の注意：概要は多すぎず少なすぎずが重要である．
%    特に，次の3点について，執筆者の取り組みの概略が読者（＝教員）に
%    伝わるようにしよう．(1) このレポートで取り組んだ課題の内容，
%    (2) 実験等によって得られた結果，(3) 結果に対しておこなった考察．\\}
プログラミング演習2においては，プログラミング演習1でC言語の実践的なプログラミングの演習を行った際に不足していた機能を追加した．
ファイルからのcsv形式のデータの読み込み，並びに書き出し．指定語句でデータを検索する機能と，メモリ中のデータを並び替える機能である．
また，完成したプログラムの結果を通して，さらなる不足機能の考察，既存コマンドの改良案と実装方法についての考察を行った．


なお，与えられたプログラムの基本仕様と要件，および，本レポートにおける実装の概要を以下に述べる．プログラムの使用方法についても記載した．

\begin{enumerate}
\setlength{\parskip}{0mm}\setlength{\itemsep}{0mm}%この1行で箇条書きの行間を調整している
\item 仕様
    \begin{enumerate}
    \item 標準入力からID，学校名，設立日，住所，備考からなるコンマ区切り形式 (CSV 形式) の名簿データを受け付けて，それらをメモリ中に登録する機能を持つ．CSV形式の例を以下に示す．

% 波括弧の内部 {...} だけ文字サイズ等を設定する書き方の例
% 以下の例はフォントサイズ：10pt 行送り：11pt
    {\fontsize{8pt}{10pt} \selectfont
        \begin{verbatim}
5100046,The Bridge,1845-11-2,14 Seafield Road Longman Inverness,SEN Unit 2.0 Open
5100224,Canisbay Primary School,1928-7-5,Canisbay Wick,01955 611337 Primary 56 3.5 Open
        :
        \end{verbatim}
    }
%% 注：行送りの変更は"指定箇所を含む段落”に効果があらわれる．
%%     fontsizeコマンドを用いて，行送りを変える場合は，
%%     その {...} の前後に空白行を入れ，段落を変えるようにすること．
%%     なお，行先頭がコメントから始まる行は空白行とは扱われない．

    \item ただし\verb|%|で始まるコマンドを受け付けて，登録してあるデータを表示したり整列したりするなどの機能を持つ．実装するコマンドを表\ref{tbl:commands}に示す．
    \end{enumerate}
\item 要件
    \begin{enumerate}
    \item 名簿データは配列などを用いて少なくとも$10000$件のデータを登録できるようにする．
          今回のプログラムでは，構造体\verb|struct profile|の配列\verb|profile_data_store[10000]|を宣言して，
          $10000$件のデータを格納できるようにする．
    \item 名簿データは構造体\verb|struct profile|および構造体\verb|struct date|を利用して，
          構造を持ったデータとしてプログラム中に定義して利用する．
          実装すべきデータ構造は表\ref{tbl:structure_profile}である．
          表中の$n$~bytesとは，$n$バイトの\verb|char|型配列を意味する．
    \end{enumerate}
\end{enumerate}

\begin{table}[t] % 表の位置は原則として t または b である．hやHは使わない．
    \centering % この1行はbegin～endの中を中央寄せにする，というコマンド
    \caption{実装するコマンド}
    \label{tbl:commands}
\begin{tabular}{|l|l|l|}
\hline
コマンド & 解説 & パラメータ範囲 \\ \hline
\verb|%C| & メモリ中のデータ件数を表示する & パラメータなし \\ \hline
\verb|%P| & メモリ中データを，$n$に応じて表示させる & \begin{tabular}[c]{@{}l@{}}n:-10000$\sim$10000\\ ($0$:全件表示\\ $n$\textgreater{}$0$:前から指定件数正順表示\\ $n$\textless{}$0$:後ろから指定件数正順表示)\end{tabular} \\ \hline
\verb|%Q| & システムを終了する & パラメータなし \\ \hline
\verb|%R| filename& filenameファイルからcsvデータを読みこむ & filename\\ \hline
\verb|%W| filename& メモリ中のデータをfilenameファイルに書き出す & filename\\ \hline
\verb|%F| word& システムを終了する & word\\ \hline
\verb|%S n| & システムを終了する & n:1から5までの正整数 \\ \hline

\end{tabular}
\end{table}
	\begin{table}[t]
	\centering % この1行はbegin～endの中を中央寄せにする，というコマンド
    \caption{名簿データ}
    \label{tbl:structure_profile}
\begin{tabular}{|l|l|l|l|l|}
\hline
ID      & 学校名      & 設立日         & 住所     & 備考  \\ \hline
32bit整数 & 70 bytes & \verb|struct date| & 70bytes & 任意長 \\ \hline
\end{tabular}
	\end{table}

また，本レポートでは以下の考察課題について考察をおこなった．

\begin{enumerate}
\setlength{\parskip}{2pt}\setlength{\itemsep}{2pt}%この1行で箇条書きの行間を調整している
    \item 不足機能に関する考察
    \item エラー処理に関する考察
    \item 新規コマンドの実装
    \item 既存コマンドの改良
\end{enumerate}
また，発展的な考察として，以下の内容についても考察を行った．
\begin{enumerate}
    \setlength{\parskip}{2pt}\setlength{\itemsep}{2pt}%この1行で箇条書きの行間を調整している
    \item 構造体のサイズ
    \item 本課題の要件に対する考察
    \item コマンドの拡張
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{プログラムの作成方針}\label{sec:housin}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 以下の5行は提出用のレポートでは必ず消すこと
%\textbf{\small ※執筆上の注意：講義中の説明などに基づいて計画した作成方針についてまとめる．
%    例えば，どういう手順で作成をおこなったのか？作成にあたって何を重視したのか？
%    この例は架空の講義内容に基づいて書かれている．実際の講義に合わせて内容や節構成を精査すること．
%    なお，コーディング中に考え直した細かい内容は，できる限り，
%    この章ではなく後の「作成過程における考察」でまとめること．\\}

プログラムをおおよそ以下の部分から構成することにした．
それぞれについて作成方針を立てる．

\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
    \item 必要なデータ構造の宣言部（\ref{sec:declare}節）
    \item 標準入力から得た CSV データの解析部（\ref{sec:parse}節）
    \item 構文解析したデータの内部形式への変換部（\ref{sec:exchange}節）
    \item 各種コマンド実現部（\ref{sec:command}節）
\end{enumerate}


%--------------------------------------------------------------%
\subsection{宣言部} 
\label{sec:declare}
%--------------------------------------------------------------%

``宣言部''は必要な構造体を宣言する部分である．
このレポートでは概要で示した表\ref{tbl:structure_profile}に基づいて，
以下のように宣言する．

{\fontsize{10pt}{11pt} \selectfont
\begin{verbatim}
    struct date {
      int y;
      int m;
      int d;
    };

    struct profile {
      int id;
      char name[70];
      struct date found;
      char add[70];
      char *others;
    };

     struct profile profile_data_store[10000];

     int profile_data_nitems = 0;

\end{verbatim}
}
%% 注：行送りの変更は"指定箇所を含む段落”に効果があらわれる．
%%     fontsizeコマンドを用いて，行送りを変える場合は，
%%     その {...} の前後に空白行を入れ，段落を変えるようにすること．
%%     なお，行先頭がコメントから始まる行は空白行とは扱われない．

ここでは，名簿管理に必要なデータを定義している．\verb|struct date|においては，設立日の設定に必要な変数\verb|y|，\verb|m|，\verb|d|を定義した．順に，設立年，設立月，設立日を表している．\verb|struct profile|では，一つ当たりデータの構造を作るために利用している．\verb|int id|はID，\verb|char name|は学校名，\verb|struct| \verb|date found|は設立日，\verb|char add|は住所，\verb|char others|は備考を設定している．これにより仕様に必要なデータを格納することが可能になっている．

%--------------------------------------------------------------%
\subsection{解析部} \label{sec:parse}
%--------------------------------------------------------------%

``解析部''は入力された文字列を判別し処理をおこなう箇所である．
しかし，このままでは，仕様を実現するための方法が曖昧であるうえフローチャートも複雑になる懸念があるうえ，今回の仕様の実現には手間が多くかかりそうである．
そこで，段階的詳細化の考え方に基づいてさらなる詳細化をおこなって，プロトタイプを作りながらボトムアップによる実装をすることにした．
まず，下記の(a)から(e)のように分割することにする．

\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
\renewcommand{\labelenumi}{(\alph{enumi})} % この1行はリスト見出しを(a), (b)に変えるためのコマンド
    \item 標準入力から読むべき行が残っている間，文字の配列\verb|char line[]|に1行分を読み込む．
    \item \verb|line|の1文字目が，\verb|'%'|ならば，2文字目をコマンド名，3文字目以降をその引数として，決定されたコマンドを実行する．
    \item さもなくば\verb|line|を新規データとみなし\verb|','|を区切りとして5つの文字列に分割する．
    \item 分割してできた5つの文字列を変換部に渡し構造体に代入する．
    \item 次の行を読み込む
\end{enumerate}
コマンドを入力させるか，新規データを入力させるか選択したのちに，以上の処理をさせるように一段階詳細化させることも考慮したが，名簿管理プログラムということが自明であるため，プログラム起動時にコマンドかそうでないかを判別して処理させることで実装した．ここで扱う文字列は最大数が$1024$に限定されているため入力文字数に注意する必要がある．

%--------------------------------------------------------------%
\subsection{変換部} \label{sec:exchange}
%--------------------------------------------------------------%

``変換部''は分割されたCSVデータもしくは新規入力データを項目毎に型変換し，
対応する構造体メンバに代入する部分である．
メンバとして様々な型を用いているため，適切な代入の使い分けが必要となる．

文字列は関数\verb|strcpy|を用いて代入する．
数値の場合，関数\verb|strtol|を用いて文字列を数値に変換してから代入する．
構造体\verb|struct date|であるメンバ\verb|y，m，d|については\verb|split|関数を実行し，文字列を分割してから代入数値としてする．

なお，構造体への代入については，\verb|strcpy|関数を用いることで容易に実装することができる．
例えば，\verb|"2014-10-25"|のような文字列を\verb|split|関数により分割し，
\verb|strcpy|関数によって入力されたデータを\verb|struct profile|内の\verb|struct date|に年と月と日を格納するという処理は，
入力された文字列を\verb|','|により分割する処理と同じ処理である．
従って，区切り文字がCSVの\verb|','|とは異なり，区切り文字が\verb|-|になること以外は同様に記述できるはずである．

また，解析部から与えられた文字列はメモリ内に保持されているものではないデータであることにも注意する必要がある．
つまり，変換部で文字列を処理する際には，入力された文字列に対して変換を行い，結果を表示をするだけではなく，
関数\verb|new_profile|を使って受け取ったデータをメモリ内に保持しておく作業を行わなければならないことに気をつける必要がある．

%--------------------------------------------------------------%
\subsection{各種コマンド実現部} \label{sec:command}
%--------------------------------------------------------------%

``各種コマンド実現部''は，表\ref{tbl:commands}にある実装コマンドの，実際の処理をおこなう部分である．
このレポートでは，具体的には，登録されているデータ件数を表示する機能と，指定形式でデータ内容を表示する機能，
外部ファイルからデータを読み込む機能，外部ファイルに書き出す機能，メモリ中のデータを並び替える機能，
データを検索する機能，また，システムを終了させるための機能の7つを実装している．

登録されているデータ件数を表示するためには（\verb|%C|），グローバル変数にて宣言している
\verb|profile| \verb|_data| \verb|_nitems|の値を表示すればよい．グローバル変数で宣言したのにも理由があり，
\verb|main|関数内でこの変数を宣言してしまうと，別関数で利用する際に値の受け渡しが発生し，手間が増えるためグローバル変数として宣言した．

登録されているデータを表示するには（\verb|%P n|）は\verb|printf|関数でメモリ内のデータを各項目毎に表示すればよい．
ただし，与えられた引数が負の場合は，逆順ではなくデータを後ろから正順で表示するため，ポインタの位置に注意する必要がある．
また，データ件数が0件の場合でも上記コマンドは実行されるが，データがないという表示を行わせている．

外部ファイルからのデータの入力(\verb|%R|)はファイル構造体のポインタを作成し，\verb|fopen()|関数を用いた．
データの書き出し(\verb|%W|)も同様に実装したが，オープンモードが異なることに注意しなければならない．
なお，書き出しの際は読み込んだファイルのCSVデータと同様の形式で書き出す仕様である.

データ検索(\verb|%F|)は，引数として入力された語句がそれぞれのデータの要素に完全一致しているかどうかで実装した．
設立日については，年月日を分割して保存したため再度文字列に変換してから文字列比較を行った．

データ整列(\verb|%S|)は整列の条件式でデータの大小を比較してバブルソートにて実装していたがクイックソートへ変更した．
変更した理由については後ほど述べる．
比較の際，文字列データについては2つの文字列の大小を比較できる\verb|strcmp()|関数を用いた．
設立日は年月日ごとに比較を行わせた．数値データは単純に減算し大小比較をしている．


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{プログラムおよびその説明}\label{sec:explain}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 以下の6行は提出用のレポートでは必ず消すこと
%\textbf{\small ※執筆上の注意：変数や数値は$\backslash$verbや\$\$
%    で囲って，適切な書体で記述することを忘れずに．
%    なお，このサンプルでは``わざと''一部の処理を省略している．
%    見た目の違いを確認して，自分のレポートでは処理を忘れないようにしよう．
%    また，この章はこのレポートサンプルの2章に基づいて書かれているが，
%    そもそも2章が架空の講義内容に基づいて書かれている点に注意すること．\\}


プログラムリストは\ref{sec:program}節に添付している．プログラムは全部で＝＝＝行からなる．
以下では，前節の作成方針における分類に基づいて，プログラムの主な構造について説明する．

%--------------------------------------------------------------%
\subsection{汎用的な関数の宣言（＝＝＝行目から＝＝＝行目）}
%--------------------------------------------------------------%

まず，汎用的な文字列操作関数として，
\verb|subst()|関数を＝＝＝から＝＝＝行目で宣言し，\verb|split()|関数を＝＝＝から＝＝＝行目で宣言，
さらに\verb|get_line()|関数を＝＝＝から＝＝＝行目で宣言している．

\verb|subst| は，引数の\verb|str|が指す文字列中の\verb|c1|文字を\verb|c2|に置き換える．
プログラム中では，入力文字列中の末尾に付く改行文字をヌル文字で置き換えるために使用している．

\verb|split| は 引数の\verb|str| が指す文字列を区切文字 \verb|c| で分割し，
分割した各々の文字列を指す複数のポインタからなる配列を返す関数である．
プログラム中では，CSVを\verb|','|で分割し，分割後の各文字列を返すのに使用されている．
また，``2004-05-10'' のような日付を表す文字列を `-' で分割して，\verb|struct date| を生成する際にも使用している．

\verb|get_line()|は，標準入力からの入力を受け付ける処理を当初実装していたが，ファイルポインタからの入力に対応ができていなかった．
そのため，それに対応した\verb|get_line_fp()|関数をファサードした．
\verb|get_line_fp()|関数はファイルポインタからの読み込みを行う関数で，\verb|get_line()|関数ではその引数として
\verb|stdin|を渡して標準入力からも受け取れるようにした．

構造体のデータを一件出力するための関数として\verb|printdata()|を，構造体を入れ替える関数として\verb|swap_struct()|関数を宣言した．
%--------------------------------------------------------------%
\subsection{変換部（＝＝＝行目から＝＝＝行目）}
%--------------------------------------------------------------%

〜行目は \verb|struct date| 型の宣言部である．メンバについては，変数\verb|y|は設立年，変数\verb|m|は設立月，
変数\verb|d|は設立日にそれぞれ対応させている．

〜行目は \verb|struct profile| 型の宣言部，〜行目はそれを扱う関数\verb|new_profile|である．
メンバについては，設立日を入れ子構造にしている．
こうすることで，要素を管理しやすくできる．なお，備考に対応する文字列\verb|*others|は任意長を許すようにしているため，
\verb|malloc|関数と\verb|strlen|関数を用いて文字列を動的に格納できるようにした. 
文字列から各データ型への変換を担う関数は，\verb|struct new\_profile| とすることで，変換部であることを明確にした．
具体的な処理内容としては，受け取った文字列\verb|str|を分割し，分割した文字列を\verb|ret1[]|に格納し，
その後要素ごとに対応する構造体メンバにエラー検出のある\verb|strncpy|関数を用いて格納している．設立日については，
\verb|ret2[]|を用意し，各メンバに対応するよう格納させている．

%--------------------------------------------------------------%
\subsection{各種コマンド実現部（aaa行目からaaa行目）}
%--------------------------------------------------------------%
a行目からの各種コマンド実現に必要な関数群は，\verb|cmd_処理名| という名前に統一することで，関数であることを明確にした．
コマンド\verb|%P|は\verb|cmd_print()|，コマンド\verb|%C|は\verb|cmd_check()|，
コマンド\verb|%Q|は\verb|cmd_quit()|，コマンド\verb|%R|は\verb|cmd_read()|，
コマンド\verb|%W|は\verb|cmd_write()|, コマンド\verb|%F|は\verb|cmd_find()|, 
コマンド\verb|%S|は\verb|cmd_sort()|にそれぞれ対応している．

124--144行目は，\verb|%P,%C,%Q,%R,%W,%F,%S|のコマンドを解釈して適切な関数を呼び出す部分である．

\verb|%P|に対応する関数\verb|cmd_print()|の処理内容としては，aからa行目に記載してある．
内容は，表\ref{tbl:commands}に記載した．

\verb|%C|，\verb|%Q|はそれぞれ，a行目からとa行目からに処理内容を記述した．
\verb|%R|,\verb|%W|はそれぞれ，a行目からとa行目からに処理内容を記述した．
\verb|%F|,\verb|%S|はそれぞれ，a行目からとa行目からに処理内容を記述した．

%--------------------------------------------------------------%
\subsection{解析部（aaa行目からbbb行目）}
%--------------------------------------------------------------%
aからb行目は\verb|main()|関数で，
aからb行目は，\verb|parse_line()|関数であり，作成方針で説明した解析部の動作におおよそ相当する．
ただし (c) の5つの文字列に分割する部分は，解析部の\verb|main()|関数では実現せず，
処理内容を明確にするために変換部である\verb|new_profile()|関数中で\verb|split|を呼出し，各要素ごとに分割を
行うことにしている．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{プログラムの使用法}\label{sec:use}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 提出するレポートでは以下5行は必ず消すこと
%\textbf{\small ※執筆上の注意：この節はプログラムの使用法を説明す
%    る節である．最低限，起動の方法，入力の形式と方法，出力の読み方
%    を入れること．当然，実装したコマンドすべてを説明すべきであるが，
%    このサンプルのように説明に使う実行例が1つである必要はない．
%    なお，このサンプルは架空の課題であり，動作環境も架空である．\\}

本プログラムは名簿データを管理するためのプログラムである．
CSV形式のコンマ区切りのデータと \% で始まるコマンドを標準入力から受け付け，
処理結果を標準出力に出力する．入力形式の詳細については，第\ref{sec:gaiyou}節を参照されたい．

プログラムは，CentOSで動作を確認しているが，
一般的な UNIX で動作することを意図している．
\verb|gcc|でコンパイルした後，標準入力から入力ファイルおよびデータを与える．

{\fontsize{10pt}{11pt} \selectfont
 \begin{verbatim}
   % gcc -Wall -o program1 program1.c
   % ./program1 <　test.txt
 \end{verbatim}
}
%% 注：行送りの変更は"指定箇所を含む段落”に効果があらわれる．
%%     fontsizeコマンドを用いて，行送りを変える場合は，
%%     その {...} の前後に空白行を入れ，段落を変えるようにすること．
%%     なお，行先頭がコメントから始まる行は空白行とは扱われない．
プログラムの出力結果としてはCSVデータの各項目を読みやすい形式で出力する．
例えば，下記の \verb|test.txt| に対して，

{\fontsize{10pt}{11pt} \selectfont
 \begin{verbatim}
  111,The Bridge,1845-11-2,Okayama,SEN Unit 2.0 Open
  222,Bower School,1908-1-19,Kagawa,01955 641225 Primary 25 2.6 Open
  333,Canisbay School,1928-7-5,Tokyo,01955 611337 Primary 56 3.5 Open
  %C
  %P 0
  %Q
 \end{verbatim}
}
\noindent % noindentとはここでは段落を変えない（一字下げをしない）というコマンド．
以下のような出力を得る．

{\fontsize{10pt}{11pt} \selectfont
 \begin{verbatim}
　　param is 0.
　　******print record data******
　　data  :     1 ------------------------------
　　Id    : 111
　　Name  : The Bridge
　　Birth : 1845-11-02
　　Addr  : Okayama
　　Com.  : SEN Unit 2.0 Open
　　--------------------------------------------
　　data  :     2 ------------------------------
　　Id    : 222
　　Name  : Bower School
　　Birth : 1908-01-19
　　Addr  : Kagawa
　　Com.  : 01955 641225 Primary 25 2.6 Open
　　--------------------------------------------
　　data  :     3 ------------------------------
　　Id    : 333
　　Name  : Canisbay School
　　Birth : 1928-07-05
　　Addr  : Tokyo
　　Com.  : 01955 611337 Primary 56 3.5 Open
　　--------------------------------------------

 \end{verbatim}
}

\noindent
入力中の\verb|%C|はこれまでの入力データの件数を表示することを示し，\verb|%P 0|は入力したデータのうち，全件のデータを表示することを示している．
なお，\verb|%Q|はシステムを終了することを示す．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{作成過程における考察}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%以下の3行は提出レポートでは不要なため消すこと．
%\textbf{\small ※執筆上の注意：ここでは，作成中に試行錯誤した内容，
%    例えば，「Aという実装ではなくBという実装にしたのはなぜか？」
%    などについて，バランスよくまとめる．\\}

第\ref{sec:housin}節で述べた実装方針に基づいて，第\ref{sec:explain}節ではその実装をおこなった．
しかし，実装にあたっては実装方針の再検討が必要になる場合があった．
本節では，名簿管理プログラムの作成過程において検討した内容，
および，考察した内容について述べる．

%--------------------------------------------------------------%
\subsection{関数\texttt{split}についての考察}
%--------------------------------------------------------------%

関数\verb|split|については方針通りに実装することができたが，容易に実装することはできなかった．
当初はコンマまでの文字列を別の配列に保存することを繰り返して実装しようとしていたが，これではコンマの数で文字列を判断することになるため失敗した．
そこで文字列を破壊的に分割し別途規定数用意した文字配列にアドレスを格納することで実装できた．文字列を丸ごとコピーすることも考えられたが，
その方法は，入力した倍のメモリ量が必要な上に使わなくなったメモリを開放する手間が増えるため用いなかった．

%--------------------------------------------------------------%
\subsection{関数\texttt{get\_line}についての考察}
%--------------------------------------------------------------%
標準入力からの入力について当初は，\verb|main|関数の中で\verb|while|文繰り返し入力を行わせて，入力の度に
入力内容が\verb|NULL|でないか調べ関数\verb|subst|を適用する方法をとっていたが，
\verb|while|文を脱する処理も記述しなければならないため手間が増えた．
そこで，今回は入力内容に問題がなければ$1$を，あれば$0$を返す方針で実装を行った．
これで，もし別の関数内で標準入力からの入力を行う際でも使いまわすことができ汎用性を持たせることができる．

%--------------------------------------------------------------%
\subsection{関数\texttt{new\_profile}についての考察}
%--------------------------------------------------------------%
関数\verb|new_profile()|の実装では，単に文字列を受け取り，その文字列を操作した後に，
用意している配列\verb|profile_data_store|にコピーする方法も考えられたが，
値を渡すことになり使用するメモリの量が増えると考えた．
そのため，ポインタによるアドレス渡しによって実装を行った．
また，配列を構造体配列として宣言しているので，ここでは構造体を返り値として設定した．
そして，文字列を数値に変換する際にはエラー検出のある\verb|strtol|関数を用いた．
%--------------------------------------------------------------%
\subsection{関数\texttt{exec\_command}についての考察}
%--------------------------------------------------------------%
仕様を満たす実装はできた．標準入力からのデータは文字列であるため，
各種コマンドへの引数を数値に変換する作業を行っている．この際，\verb|atoi|関数だとうまく変換されないことがあったため\verb|strtol|
関数を用いている．
また，定義されていないコマンドが入力された際は該当するコマンドがないという表示を出すようにした．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_print}についての考察}
%--------------------------------------------------------------%
まず，受け取った\verb|param|の値が正か負か$0$を判断させなくてはならない．
その後，正ならば指定件数分前から順に表示させ，$0$ならば全件表示を行わせて，
負ならば\verb|param|の値を一度正に戻し指定件数分ポインタを移動させた後に正のとき同様に表示処理を行わせる手順で実装を行った．
表示させる部分については，\verb|find|関数にて利用するため\verb|printdata|関数を別途作成し，当該関数内で表示させた．
%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_check}についての考察}
%--------------------------------------------------------------%
この関数の実装はあらかじめ，登録件数を保存するための変数をグローバル変数にて宣言することで容易に実装することができた．
誤ったデータが入力された際も当初は件数が増えてしまう実装であったため，増やさないように改変を行った．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_quit}についての考察}
%--------------------------------------------------------------%
この関数の実装は，\verb|stdio.h|にある\verb|exit|関数を利用することにより実装を行った．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_read}についての考察}
%--------------------------------------------------------------%
外部ファイルからのデータ入力は，\verb|stdio.h|にある\verb|fopen|関数並びに\verb|fclose|関数を
利用することで実装した．ファイルポインタの内部の仕組みを理解できてはないが，作成中にファイル名が異なると開けずに
システムが強制終了するため回避する処理が必要だった．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_write}についての考察}
%--------------------------------------------------------------%
上記の\verb|cmd_read|同様に実装行った．ただし，データを書き込むためオープンモードを書き込み状態にした．
\verb|fprintf|を用いてファイルポインタとして開いたファイルにコンマ区切りで書き込むため，データ形式には気を付けた．
1データの終わりに改行を置くことを当初忘れていたため望む実装ができず苦戦した．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_find}についての考察}
%--------------------------------------------------------------%
本関数は，各要素が\verb|%F|の引数として与えられたデータを完全に一致しているかどうかで実装をしようとしたが，入力される引数が文字データで
あることを考慮しておらず苦悩した．構造体\verb|profile|の要素の\verb|name,add,others|は文字であるから\verb|strcmp|関数にて比較可能で，
\verb|id|についても\verb|strtol|関数を用いた比較が可能である．しかし，\verb|found|は年月日ごとに別の構造体に数値としてバラバラにあるため，
一度csvデータと同じ\verb|'-'|で繋がった形式に別途関数を介し変換させた後に別のデータ同様に文字列として比較を行った．

%--------------------------------------------------------------%
\subsection{関数\texttt{cmd\_sort}についての考察}
%--------------------------------------------------------------%
ソートについては苦労が大きく実装に手間取った．文字列の比較がわからなかったが\verb|strcmp|関数が適していると知りなんとか実装ができた．
要素の大小の結果をソートの比較条件に利用した．交換の回数をカウントしバブルソートとクイックソートの比較を行った（第\ref{sec:kison}節)結果，
クイックソートを実装した．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{結果に関する考察}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%以下の5行は提出レポートでは不要なため消すこと．
%\textbf{\small ※執筆上の注意：考察課題を中心にまとめる．
%    自分で考えた考察課題を書くことも強く推奨しているが，
%    「作成過程における考察」とは区別して書くこと．
%    「作成されたプログラムから考察できること」を求めている．
%    また，単なる感想で終わるような内容を書いてはいけない．\\}

演習課題のプログラムについて仕様と要件をいずれも満たしていることを
プログラムの説明および使用法における実行結果例によって示した．
ここでは，概要で挙げた以下の項目について考察を述べる．

\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
    \item 不足機能についての考察
    \item エラー処理についての考察
\end{enumerate}

%--------------------------------------------------------------%
\subsection{不足機能についての考察}\label{sec:husoku}
%--------------------------------------------------------------%
不足機能については，以下の内容が考えられる．
\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
   \item 入力後のデータ修正機能
   \item 指定要素のみ表示させる機能 
\end{enumerate}
%-------------------------------------------------------------%
\subsubsection{入力後のデータ修正機能}
%-------------------------------------------------------------%
現在の機能では，データの形式さえあっていれば名簿データとして追加されるため，データの内容を間違って入力しても追加される．
これを回避するために，\ref{sec:sakujyo}節にて指定データを削除する機能を実装している．しかし，削除に再度長いデータを
入力する必要があり不便極まりない．

名前を間違えたら名前のみを，住所を再度編集したい場合は住所のみを書き換えるという機能があればより現実的に利用ができる
名簿管理プログラムになるのではないだろうか．
%-------------------------------------------------------------%
\subsubsection{指定要素のみ表示させる機能}
%-------------------------------------------------------------%
これは\verb|cmd_print|を改良すれば実装ができそうである．
\verb|cmd_print|はすべての要素を表示させている．そこに一つ引数を増やすかもしくは別のコマンドを作成し、
表示させたい要素と数値を紐付けする．例えば$1$ならばIDのみを\verb|%P|のように表示させる実装が可能そうだ．
この機能は\ref{sec:printyouso}節にて実装を行ったため該当する節を参照されたい．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--------------------------------------------------------------%
\subsection{エラー処理についての考察}
%--------------------------------------------------------------%
\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
    \item CSVデータ処理中のエラー処理
    \item new\_profile関数におけるエラー処理
\end{enumerate}


%--------------------------------------------------------------%
\subsubsection{CSVデータ処理中のエラー処理}
%--------------------------------------------------------------%

CSVデータ中に，不正なデータが含まれていた場合の処理について考察する．

エラーのあった行を指摘せず，終了または無視するという方法も考えられるが，正常終了との区別が付かない上に，
どの状態でエラーが発生しているのか確認をとることができないため実用的でないと考えた．
今回は，エラーのあった行を指摘して，無視する方法で実装を行っている箇所が多々ある．

プログラム中に\verb|ERROR:|で始まる表示をを書いてエラー目印としている．
また，エラーのあった内容を指摘するためには，\verb|enum|という機能を利用してどのエラーなのかユーザが一度見て理解できるように，
標準エラー出力を利用してエラーの内容を表示させている．

しかし，これはデータの型や仕様に指定されたデータ件数時にしかエラー処理を行っていないため他にも実装の余地はあると考える．
例えば設立年月日について見ると，設立年はマイナス値，
一桁や二桁は不自然だろうし設立月についても$12$より大きい数字は現在の暦では利用されていないはずである．
利用する上でのエラーというものを考慮する必要があると考察する．

%--------------------------------------------------------------%
\subsubsection{\texttt{new\_profile}関数におけるエラー処理}
%--------------------------------------------------------------%
本プログラムは，データがすでに10000件ある状態で新規入力が行われた場合でも一度\verb|new_profile|関数を実行する．
といっても，関数のはじめにデータ件数を確認しており10000件を超えるデータは保存されないようになっている.

その状態だと条件を調べるために\verb|new_profile|関数を介しメモリを確保するなどと無駄な作業が発生しているため，
内部的な処理目的のためのエラー処理を導入してもよいのではと考えた．

実装案としては，\verb|parse_line|を実行時に条件分岐を行う際にprofile\_data\_nitemsの中身を確認し，
10000件を超えるようであれば処理を行わなくすれば良い．以下実装案のプログラムである．
\begin{verbatim}
void parse_line(char *line){
    if(line[0]=='%'){
        exec_command(line[1], &line[3]);
    }
    else if(profile_data_nitems==10000){
    //件数エラーと表示するもしくは，本関数から抜ける．
    }
    else{
        new_profile(&profile_data_store[profile_data_nitems],line);
    }
}
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--------------------------------------------------------------%
\subsection{新規コマンドの実装}
%--------------------------------------------------------------%
新規コマンドについては第\ref{sec:husoku}節を基に以下の実装を行った．
\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
    \item 指定データの削除コマンド
    \item どのようなコマンドあるか表示するコマンド
    \item 指定要素のみ表示させるコマンド
\end{enumerate}
%--------------------------------------------------------------%
\subsubsection{指定データの削除コマンド}\label{sec:sakujyo}
%--------------------------------------------------------------%
本関数は，\verb|exec_command|に\verb|%D|として新たに定義して利用できるようにした．
処理内容としては簡単なものであり，削除したいデータをその一つあとのデータですべてのデータを上書き
するものである．しかし，データ件数の値である\verb|profiel_data_nitems|の値は減らないため，
その値を一つ減らすことで対応している．

プログラムは第\ref{sec:program}節のｘｘｘ行目からｘｘｘ行目にある関数\verb|cmd_delete|である．
%--------------------------------------------------------------%
\subsubsection{どのようなコマンドあるか表示するコマンド}\label{sec:help}
%--------------------------------------------------------------%
本関数は，増えてきた本プログラムの機能をわかりやすくユーザに伝えるために作成した．
どのような機能があるかを設定し\verb|fprintf|関数を用いて標準エラー出力に出力させている．
出力データを記載した外部データを用意することも考えたが，そのデータを用いてなにか計算を行わせることは
なかったためプログラム内に記載することで実装を完了した．

プログラムは第\ref{sec:program}節のｘｘｘ行目からｘｘｘ行目にある関数\verb|cmd_help|である．
%--------------------------------------------------------------%
\subsubsection{指定要素のみ表示させるコマンド}\label{sec:printyouso}
%--------------------------------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--------------------------------------------------------------%
\subsection{既存コマンドの改良}\label{sec:kison}
%--------------------------------------------------------------%
既存コマンドの改良は以下の内容で行った．
\begin{enumerate}
\setlength{\parskip}{2pt} \setlength{\itemsep}{2pt}
    \item　語句の検索の部分一致
\end{enumerate}
%-------------------------------------------------------------%
\subsubsection{語句の検索の部分一致}
%-------------------------------------------------------------%
現在の\verb|cmd_find|は文字列の完全一致による実装であるため，システムとして利用するには不便である．
完全一致ではなく部分一致を行うことができれば検索機能が柔軟になると考えた.

実装方法としては，検索される文字列と探したい文字列を比較を行う．検索される文字列の中に探したい文字列の先頭文字があるかどうか探す．
そこから各文字列の文字を一つずつ見ていき，
探したい文字列がすべて見終わったら部分文字列が一致していることになるため検索が可能になると考える．
以下考察したプログラムである．部分文字列が一致すると$0$を返し，それ以外は$1$を返す．
\begin{verbatim}
int find_kai(char *s, char * cp)
{
	char *s1, *s2;
	if( *cp == '\0') return s; /*cpの文字列長が0ならsを返す*/ 

	while( *s != '\0'){
		while(*s != '\0' && *s != *cp) {/*先頭文字が合うまで探す*/
			s++;
		}
		if(*s == '\0') return 1;/*見つからない*/
		s1 = s;
		s2 = cp;
		while ( *s1 == *s2 && *s1 != '\0'){ /*cpの先頭以降の文字列が一致するか*/
			s1++;
			s2++;
		}
		if( *s2 == '\0'){/* cp の文字列は、全て一致した*/
			return 0;
		}
		s++; /*次の位置から、調べ直す*/
	}
	return 1;/*見つからない*/
}
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{発展課題}\label{sec:hatten}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{感想}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
課題が与えられた際は，実装方針が全くわからず完成するか不安だった．
しかし，いきなりプログラムを組むのではなく，日本語で段階的に流れを組み，徐々に詳細化していき，
プログラムをしていくという方法を学んだため，頭でイメージを立てながらプログラムを組むことができた．
しかし，メモリ使用量などデータ構造についてはさらに検討の余地があると感じる．
また，C言語は，オブジェクト指向型言語ではないがポインタや構造体を用いることでこれに近い動きをできることに驚いた．
しかし，文字列の代入や値の受け渡しについては最近の言語とは異なることが多いように感じた．
今回の課題を通して，ポインタと構造体に関する理解を深められたように思うが，まだまだ足りないため，
考察内容を実装する中でさらに理解を深められるようにしたい．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{作成したプログラム}\label{sec:program}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

作成したプログラムを以下に添付する．

%
% 行番号付きのリストを挿入
%   cat -n ds-sample.c > ds-sample.txt
% としたものを貼付する．
% なお， fold コマンドを使うと指定行数で折り返すことができる．
% 詳しくは fold --help を実行してヘルプを読んでみるとよい．
%
{\fontsize{10pt}{11pt} \selectfont
\begin{verbatim}
    ここにプログラム
\end{verbatim}
}
%% 注：行送りの変更は"指定箇所を含む段落”に効果があらわれる．
%%     fontsizeコマンドを用いて，行送りを変える場合は，
%%     その {...} の前後に空白行を入れ，段落を変えるようにすること．
%%     なお，行先頭がコメントから始まる行は空白行とは扱われない．

% 以下の3行は提出用のレポートでは必ず消すこと．
%\textbf{\small ※執筆上の注意：余白部分に文字がはみ出していないか，よく確認する．
%    例えば，\LaTeX によるコンパイル時のWarningメッセージを確認しよう．
%    \texttt{Overfull hbox}が出ていたら，はみ出している場所があるはずである．}

\end{document}
